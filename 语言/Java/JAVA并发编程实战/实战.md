#JAVA #å¤šçº¿ç¨‹ 

## é›¶ã€åº
åœ¨çœ‹Effective Javaçš„æ—¶å€™ï¼Œå‘ç°Josh Blochè¿™ä¸ªäººæ˜¯çœŸçš„å‰å®³ã€‚æƒ³èµ·æ¥ä¹‹å‰ä»–å†™çš„ã€ŠJavaå¹¶å‘ç¼–ç¨‹å®æˆ˜ã€‹ï¼Œè¿˜æœ‰Doug Leaç­‰JUCå®ç°è€…çš„å‚ä¸ã€‚äºæ˜¯å‡†å¤‡å¥½å¥½çœ‹çœ‹ã€‚ 

è¿™æœ¬ä¹¦çš„ä¸­æ–‡ç¿»è¯‘ç‰ˆçœ‹ç€æœ‰ç‚¹åˆ«æ‰­ï¼Œé‡åˆ°å¥‡æ€ªçš„åœ°æ–¹åˆšå¥½æœ‰è‹±æ–‡ç‰ˆçš„å°è¯•çœ‹çœ‹ã€‚å˜¿å˜¿ğŸ˜

## ä¸€ã€æµ…è°ˆå¤šçº¿ç¨‹
### 1.1 å¤šçº¿ç¨‹çš„ä¼˜åŠ¿
- **å……åˆ†å‘æŒ¥å¤šå¤„ç†å™¨çš„èƒ½åŠ›** æ“ä½œç³»ç»Ÿè°ƒåº¦çš„åŸºæœ¬å•ä½æ˜¯çº¿ç¨‹ï¼Œå¦‚æœè¿›ç¨‹åªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆ
- **æ›´æ–¹ä¾¿çš„å»ºæ¨¡** å¤„ç†ä¸€ç§å†…å®¹çš„ç¨‹åºè¦æ¯”å¤„ç†å¤šä¸ªçº¿ç¨‹çš„ç¨‹åºæ›´å®¹æ˜“
- **å¼‚æ­¥äº‹ä»¶çš„ç®€åŒ–å¤„ç†** å¤šä¸ªçº¿ç¨‹å¤„ç†å¤šä¸ªè¯·æ±‚æ¯”åŒä¸€ä¸ªçº¿ç¨‹å¤„ç†å¤šä¸ªè¯·æ±‚å®¹æ˜“çš„å¤š
- **å“åº”æ›´çµæ•çš„ç”¨æˆ·ç•Œé¢** ç°ä»£GUIå·¥å…·ä½¿ç”¨ä¸€ä¸ªEDTï¼ˆevent dispatch threadï¼‰çº¿ç¨‹æ¥ä»£æ›¿äº‹ä»¶ä¸»å¾ªç¯ï¼ˆäº‹ä»¶å¾ªç¯æ”¾åœ¨äº†çº¿ç¨‹å†…éƒ¨ï¼‰

### 1.2 çº¿ç¨‹çš„é£é™©
- **çº¿ç¨‹å®‰å…¨æ€§** ä¸åŒçº¿ç¨‹ä¿®æ”¹åŒä¸€å˜é‡ç­‰ã€‚ã€‚ã€‚
- **æ´»è·ƒæ€§é—®é¢˜** æŸä»¶æ­£åœ¨æ‰§è¡Œçš„äº‹æƒ…å¿…é¡»æ‰§è¡Œã€‚ä¸èƒ½å› ä¸ºæ­»é”ä¸æ‰§è¡Œç­‰
- **æ€§èƒ½é—®é¢˜** çº¿ç¨‹åˆ›å»ºå¼€é”€ã€ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ã€‚æ­¤å¤–ï¼ŒåŒæ­¥æœºåˆ¶è¿˜ä¼šæŠ‘åˆ¶ç¼–è¯‘å™¨ä¼˜åŒ–ï¼Œä½¿å†…å­˜ä¸­çš„æ•°æ®å¤±æ•ˆã€å¢åŠ å…±äº«å†…å­˜æ€»çº¿çš„åŒæ­¥æµé‡ã€‚

## äºŒã€çº¿ç¨‹å®‰å…¨æ€§
ç¼–å†™çº¿ç¨‹å®‰å…¨çš„ä»£ç ï¼Œæ ¸å¿ƒåœ¨äºè¦å¯¹**çŠ¶æ€è®¿é—®æ“ä½œ**è¿›è¡Œç®¡ç†ï¼Œç‰¹åˆ«æ˜¯**å…±äº«çš„**å’Œ**å¯å˜çš„**çŠ¶æ€çš„è®¿é—®ã€‚

> çŠ¶æ€ä¸€èˆ¬æ˜¯æŒ‡å­˜å‚¨åœ¨çŠ¶æ€å˜é‡ä¸­çš„æ•°æ®ï¼ˆç›´æ¥æˆ–é—´æ¥ï¼‰
> å¦‚ï¼šHashMapä¸­çš„çŠ¶æ€é™¤äº†HashMapæœ¬èº«ï¼Œè¿˜æœ‰Map.Entry

Javaä¸­çš„åŒæ­¥æœºåˆ¶ï¼š`synchronized`ã€`volatile`ã€æ˜¾å¼é”ã€åŸå­å˜é‡

### 2.1 å®šä¹‰
çº¿ç¨‹å®‰å…¨æ€§çš„æ ¸å¿ƒæ˜¯æ­£ç¡®æ€§ã€‚æ‰€è°“çš„æ­£ç¡®æ€§ï¼Œå°±æ˜¯æŸä¸ªç±»çš„è¡Œä¸ºä¸å…¶è§„èŒƒå®Œå…¨ä¸€è‡´ã€‚å› æ­¤ï¼Œçº¿ç¨‹å®‰å…¨æ€§å¯ä»¥å®šä¹‰ä¸ºï¼šå½“å¤šä¸ªçº¿ç¨‹è®¿é—®æŸä¸ªç±»æ—¶ï¼Œè¿™ä¸ªç±»å§‹ç»ˆéƒ½èƒ½è¡¨ç°å‡ºæ­£ç¡®çš„è¡Œä¸ºï¼Œé‚£ä¹ˆè¿™ä¸ªç±»å°±æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

> çº¿ç¨‹å®‰å…¨ç±»ä¸­å°è£…äº†å¿…è¦çš„åŒæ­¥æœºåˆ¶ï¼Œè°ƒç”¨è€…ä¸éœ€è¦å†é‡‡å–åŒæ­¥æœºåˆ¶ç¡®ä¿æ­£ç¡®æ€§ã€‚

æ— çŠ¶æ€å¯¹è±¡ä¸€å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„

> **æ— çŠ¶æ€** æ—¢ä¸åŒ…å«ä»»ä½•åŸŸï¼Œä¹Ÿä¸åŒ…å«ä»»ä½•å¯¹å…¶ä»–ç±»ä¸­åŸŸçš„å¼•ç”¨

### 2.2 åŸå­æ€§
```java
@NotThreadSafe
public UnSafeCounting {
	private long count = 0;
	public void calc() {
		++count;
	}
}
```
è¿™é‡Œçš„`++count`å®é™…åŒ…å«ä¸‰ä¸ªæ“ä½œï¼šè¯»å–ã€ä¿®æ”¹ã€å†™å…¥ã€‚å½“å¤šçº¿ç¨‹æ‰§è¡Œæ—¶ï¼Œå°±å¯èƒ½å‡ºç°countè®¡ç®—é”™è¯¯ï¼ˆå¦‚ï¼Œä¸¤ä¸ªçº¿ç¨‹åŒæ—¶è¯»åˆ°countéƒ½æ˜¯9ï¼‰ã€‚

#### ç«æ€æ¡ä»¶
**ç«æ€æ¡ä»¶**ï¼šç”±äºä¸æ°å½“çš„æ‰§è¡Œæ—¶åºè€Œå‡ºç°ä¸æ­£ç¡®çš„ç»“æœã€‚ æœ€å¸¸è§çš„ç«æ€æ¡ä»¶ç±»å‹æ˜¯â€œå…ˆæ£€æŸ¥åæ‰§è¡Œâ€ï¼Œå³é€šè¿‡ä¸€ä¸ªå¯èƒ½å¤±æ•ˆçš„è§‚æµ‹ç»“æœæ¥è¿›è¡Œä¸‹ä¸€æ­¥çš„æ“ä½œã€‚

#### å»¶è¿Ÿåˆå§‹åŒ–ä¸­çš„ç«æ€æ¡ä»¶
```java
@NotThreadSafe 
public class LazyInitRace{
	private ExpensiveObject instance = null;
	public ExpensiveObject getInstance() {
		if (instance == null)
			instance = new ExpensiveObject();
		return instance;
	}
}
```
å¤šçº¿ç¨‹æ—¶ï¼Œä¸èƒ½ä¿è¯å•ä¾‹ã€‚

#### å¤åˆæ“ä½œ
> **åŸå­**ï¼šå¦‚æœæœ‰ä¸¤ä¸ªæ“ä½œAå’ŒBï¼Œå¦‚æœä»æ‰§è¡ŒAçš„çº¿ç¨‹æ¥çœ‹ï¼Œå½“å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒBæ—¶ï¼Œè¦ä¹ˆBå…¨éƒ¨æ‰§è¡Œå®Œï¼Œè¦ä¹ˆBå®Œå…¨ä¸æ‰§è¡Œï¼Œé‚£ä¹ˆAå’ŒBå¯¹å½¼æ­¤å°±æ˜¯åŸå­çš„ã€‚
> 
> **åŸå­æ“ä½œ**ï¼šå¯¹äºè®¿é—®åŒä¸€ä¸ªçŠ¶æ€çš„æ‰€æœ‰æ“ä½œï¼ˆåŒ…æ‹¬æ“ä½œæœ¬èº«ï¼‰æ¥è¯´ï¼Œè¿™ä¸ªæ“ä½œæ˜¯ä¸€ä¸ªä»¥åŸå­æ–¹å¼æ‰§è¡Œçš„æ“ä½œã€‚

å½“åœ¨æ— çŠ¶æ€ç±»ä¸­å¢åŠ ä¸€ä¸ªçŠ¶æ€æ—¶ï¼Œå¦‚æœè¯¥çŠ¶æ€å®Œå…¨ç”±çº¿ç¨‹å®‰å…¨çš„å¯¹è±¡æ¥ç®¡ç†ï¼ˆå¦‚å¢åŠ ä¸€ä¸ªAtomicLongç®¡ç†çš„å­—æ®µï¼‰ï¼Œé‚£ä¹ˆè¯¥ç±»ä»ç„¶æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚å½“çŠ¶æ€ç”±ä¸€ä¸ªå˜æˆå¤šä¸ªæ—¶ï¼Œå°±ä¼šå¤æ‚çš„å¤šã€‚

> å°½é‡ç”¨ç°æœ‰çš„çº¿ç¨‹å®‰å…¨å¯¹è±¡ï¼ˆå¦‚Atomicå¯¹è±¡ï¼‰æ¥ç®¡ç†ç±»çš„çŠ¶æ€ã€‚

### 2.3 é”æœºåˆ¶
å½“ä¸€ä¸ªç±»ä¸­å­˜åœ¨å¤šä¸ªçŠ¶æ€æ—¶ï¼Œå³ä½¿è¿™äº›çŠ¶æ€éƒ½æ˜¯ç”±çº¿ç¨‹å®‰å…¨çš„ç±»ç®¡ç†çš„ï¼ˆå¦‚éƒ½æ˜¯Atomicçš„ï¼‰ï¼Œåœ¨å¾ˆå¤šæƒ…å†µä¸‹ä¹Ÿä¸èƒ½ä¿è¯è¯¥ç±»æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä»ç„¶ä¼šå­˜åœ¨ç«æ€æ¡ä»¶ã€‚

#### å†…ç½®é”
åŒæ­¥ä»£ç å—ï¼ˆ`synchronized (lock) {}`ï¼‰
`sychronized`ä¿®é¥°æ–¹æ³•æ—¶ï¼Œé»˜è®¤lockæ˜¯å½“å‰å¯¹è±¡ï¼ˆ`this`ï¼‰ã€‚

#### é‡å…¥
å†…ç½®é”å…è®¸æŸä¸ªçº¿ç¨‹é‡å¤è·å–ä¸€ä¸ªå·²ç»ç”±å®ƒè‡ªå·±æŒæœ‰çš„é”ã€‚

> æ¯ä¸ªå…±äº«çš„å’Œå¯å˜çš„å˜é‡éƒ½åº”è¯¥åªç”±ä¸€ä¸ªé”æ¥ä¿æŠ¤ï¼Œä»è€Œä½¿ç»´æŠ¤äººå‘˜çŸ¥é“æ˜¯å“ªä¸ªé”ã€‚

#### é”çš„ä½¿ç”¨
ä¸€ç§å¸¸è§çš„åŠ é”çº¦å®šæ˜¯ï¼Œå°†æ‰€æœ‰å¯å˜çŠ¶æ€éƒ½å°è£…åœ¨å¯¹è±¡å†…éƒ¨ï¼Œå¹¶é€šè¿‡å¯¹è±¡çš„å†…ç½®é”å¯¹å¯¹è±¡æ‰€æœ‰è®¿é—®å¯å˜çŠ¶æ€çš„ä»£ç è·¯å¾„è¿›è¡ŒåŒæ­¥ï¼Œä½¿å¾—åœ¨è¯¥å¯¹è±¡ä¸Šä¸ä¼šå‘ç”Ÿå¹¶å‘è®¿é—®ã€‚

> å¯¹äºæ¯ä¸ªåŒ…å«å¤šä¸ªå˜é‡çš„ä¸å˜æ€§æ¡ä»¶ï¼Œå…¶ä¸­æ¶‰åŠçš„æ‰€æœ‰å˜é‡éƒ½éœ€è¦ç”¨åŒä¸€ä¸ªé”æ¥ä¿æŠ¤ã€‚

è™½ç„¶`synchronized`å¯ä»¥ç¡®ä¿å•ä¸ªæ“ä½œçš„åŸå­æ€§ï¼Œä½†å¯¹å¤šä¸ªæ“ä½œç»„æˆçš„å¤åˆæ“ä½œè¿˜éœ€è¦é™„åŠ é¢å¤–çš„é”æ¥ä¿è¯æ“ä½œçš„åŸå­æ€§ã€‚å¦‚
```
if (!vector.contains(a)) {
	vector.add(a);
}
```
è¿™é‡Œå³ä½¿containså’Œaddéƒ½æ˜¯åŸå­æ“ä½œï¼Œä¹Ÿä¸èƒ½ä¿è¯ä¸å­˜åœ¨ç«æ€æ¡ä»¶ã€‚

> æ¯ä¸ªæ–¹æ³•éƒ½æ‰€è°“åŒæ­¥æ–¹æ³•ä¸èƒ½ä¿è¯å¤åˆæ“ä½œçš„åŸå­æ€§ã€‚åŒæ—¶ï¼Œè¿˜ä¼šå­˜åœ¨æ´»è·ƒæ€§é—®é¢˜ã€æ€§èƒ½é—®é¢˜ï¼


### 2.4 æ´»è·ƒæ€§ä¸æ€§èƒ½ 

```java
@ThreadSafe  
public class SynchronizedFactorizer implements Servlet {  
    @GuardedBy("this") private BigInteger lastNumber;  
    @GuardedBy("this") private BigInteger[] lastFactors;  
    public synchronized void service(ServletRequest req,  
                                     ServletResponse resp) {  
        BigInteger i = extractFromRequest(req);  
        if (i.equals(lastNumber)) {  
            encodeIntoResponse(resp, lastFactors);  
        } else {  
            BigInteger[] factors = factor(i);  
            lastNumber = i;  
            lastFactors = factors;  
            encodeIntoResponse(resp, lastFactors);  
        }  
    }  
}
```
ä¸Šè¿°ä»£ç é”çš„ç²’åº¦å¤ªå¤§ï¼Œå½±å“æ€§èƒ½ã€‚

```java
@ThreadSafe  
public class CachedFactorizer implements Servlet {  
    @GuardedBy("this") private BigInteger lastNumber;  
    @GuardedBy("this") private BigInteger[] lastFactors;  
    @GuardedBy("this") private long hits;  
    @GuardedBy("this") private long cacheHits;  
  
    public synchronized void service(ServletRequest req,  
                                     ServletResponse resp) {  
        BigInteger i = extractFromRequest(req);  
        BigInteger[] factors = null;  
        synchronized (this) {  
            ++hits;  
            if (i.equals(lastNumber)) {  
                ++cacheHits;  
                factors = lastFactors.clone();  
            }  
        }  
        if (factors == null) {  
            factors = factor(i); //è€—æ—¶æ“ä½œä¸æ”¾åœ¨é”å†…  
            synchronized (this) {  
                lastNumber = i;  
                lastFactors = factors.clone();  
            }  
        }  
        encodeIntoResponse(resp, lastFactors);  
    }  
 
}
```

è¦åˆ¤æ–­åŒæ­¥ä»£ç å—çš„åˆç†å¤§å°ï¼Œéœ€è¦åœ¨å„ç§è®¾è®¡éœ€æ±‚ä¹‹é—´è¿›è¡Œæƒè¡¡ï¼ŒåŒ…æ‹¬å®‰å…¨æ€§ï¼ˆå¿…é¡»æ»¡è¶³ï¼‰ã€ç®€å•æ€§å’Œæ€§èƒ½ã€‚ä¸èƒ½ç›²ç›®çš„ä¸ºäº†æ€§èƒ½è€Œç‰ºç‰²ç®€å•æ€§ï¼ˆå¯èƒ½å¯¹å®‰å…¨æ€§é€ æˆç ´åï¼‰ã€‚

> å½“æ‰§è¡Œæ—¶é—´è¾ƒé•¿çš„è®¡ç®—æˆ–è€…å¯èƒ½æ— æ³•å¿«é€Ÿå®Œæˆçš„æ“ä½œï¼ˆç½‘ç»œIOæˆ–æ§åˆ¶å°IOï¼‰æ—¶ï¼Œä¸€å®šä¸è¦æŒæœ‰é”ã€‚

## ä¸‰ã€å¯¹è±¡çš„å…±äº«

ç¬¬äºŒç« ä¸­çš„åŒæ­¥æ˜¯é¿å…å¤šä¸ªçº¿ç¨‹åŒä¸€æ—¶åˆ»è®¿é—®ç›¸åŒçš„æ•°æ®ã€‚æœ¬ç« ä»‹ç»å¦‚ä½•å…±äº«å’Œå‘å¸ƒå¯¹è±¡ï¼Œæ˜¯ä»–ä»¬èƒ½å¤Ÿå®‰å…¨çš„ç”±å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ã€‚

synchonizedå…³é”®å­—çš„ä½œç”¨ä¸ä»…æ˜¯å®ç°**åŸå­æ€§**æˆ–ç¡®å®š**ä¸´ç•ŒåŒº**ï¼Œè¿˜æœ‰ä¸€ä¸ªé‡è¦çš„åŸå› **å†…å­˜å¯è§æ€§**ã€‚
- é˜²æ­¢å½“ä¸€ä¸ªçº¿ç¨‹æ­£åœ¨ä½¿ç”¨å¯¹è±¡çŠ¶æ€æ—¶ï¼Œå¦ä¸€ä¸ªå¯¹è±¡åŒæ—¶ä¿®æ”¹è¯¥å¯¹è±¡çŠ¶æ€
- å½“ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†å¯¹è±¡çŠ¶æ€åï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿçœ‹åˆ°å‘ç”Ÿçš„çŠ¶æ€å˜åŒ–

### 3.1 å¯è§æ€§
æ•°æ®åªè¦åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«ï¼Œ**å°±å¿…é¡»ä½¿ç”¨åŒæ­¥æœºåˆ¶**ã€‚åœ¨æ²¡æœ‰åŒæ­¥çš„æƒ…å†µä¸‹ï¼Œç¼–è¯‘å™¨ã€å¤„ç†å™¨ä»¥åŠè¿è¡Œæ—¶éƒ½å¯èƒ½å¯¹æ“ä½œçš„æ‰§è¡Œé¡ºåºè¿›è¡Œä¸€äº›æ„æƒ³ä¸åˆ°çš„è°ƒæ•´ã€‚åœ¨ç¼ºä¹è¶³å¤ŸåŒæ­¥çš„å¤šçº¿ç¨‹ç¨‹åºä¸­ï¼Œè¦æƒ³å¯¹å†…å­˜æ“ä½œçš„æ‰§è¡Œé¡ºåºè¿›è¡Œåˆ¤æ–­ï¼Œå‡ ä¹æ— æ³•å¾—å‡ºæ­£ç¡®çš„ç»“è®ºã€‚

```java
public class NoVisibility {  
    private static boolean ready;  
    private static int number;  
  
    private static class ReaderThread extends Thread {  
        public void run() {  
            while (!ready) {  
                Thread.yield();  
            }  
            System.out.println(number);  
        }  
    }  
  
    public static void main(String[] args) throws InterruptedException {  
        new ReaderThread().start();  
        number = 42;  
        ready = true;  
    }  
}
```

> `Thread.yield()`æ–¹æ³•ï¼Œä½¿çº¿ç¨‹ç”±æ‰§è¡ŒçŠ¶æ€å˜ä¸ºå°±ç»ªçŠ¶æ€ã€‚

ä¸Šè¿°ä»£ç æ‰“å°å¯èƒ½æ˜¯0ï¼Œä¹Ÿæœ‰å¯èƒ½æ°¸è¿œæ­»å¾ªç¯ã€‚

```java
@NotThreadSafe  
public class SynchronizedInteger {  
    private int value;  
  
    public int getValue() {  
        return value;  
    }  
  
    public void setValue(int value) {  
        this.value = value;  
    }  
}
```

å¦ä¸€ä¸ªçº¿ç¨‹å¯èƒ½çœ‹ä¸åˆ°ä¸€ä¸ªçº¿ç¨‹å¯¹valueçš„ä¿®æ”¹ã€‚å¿…é¡»ä½¿ç”¨åŒæ­¥ï¼Œç»™getterå’ŒsetteråŠ ä¸Š`synchronized`åŒæ­¥ã€‚

> ä¸å¯è§çš„åŸå› æ˜¯ï¼Œæ¯ä¸ªçº¿ç¨‹æ‹¥æœ‰è‡ªå·±çš„ä¸€ä¸ªé«˜é€Ÿç¼“å­˜åŒºâ€”â€”**çº¿ç¨‹å·¥ä½œå†…å­˜**ã€‚ä»ç¼“å­˜åˆ·æ–°åˆ°å†…å­˜éœ€è¦åŒæ­¥ã€‚

### 3.2 éåŸå­çš„64ä½æ“ä½œ
å¯¹äºé`volatile`çš„`long`å’Œ`double`ï¼ŒJVMå…è®¸å°†64ä½çš„è¯»/å†™æ“ä½œåˆ†è§£ä¸ºä¸¤ä¸ª32ä½æ“ä½œã€‚

### 3.3 åŠ é”ä¸å¯è§æ€§
åŠ é”çš„å«ä¹‰ä¸ä»…ä»…å±€é™äºäº’æ–¥è¡Œä¸ºï¼Œè¿˜åŒ…æ‹¬å†…å­˜å¯è§æ€§ã€‚ä¸ºäº†ç¡®ä¿æ‰€æœ‰çº¿ç¨‹éƒ½èƒ½çœ‹åˆ°å…±äº«å˜é‡çš„æœ€æ–°å€¼ï¼Œæ‰€æœ‰æ‰§è¡Œè¯»æ“ä½œæˆ–è€…å†™æ“ä½œçš„çº¿ç¨‹å¿…é¡»åœ¨åŒä¸€ä¸ªé”ä¸ŠåŒæ­¥ã€‚

![](_attachments/9ca5b363c287433240f22abecf7e4866.png)

### 3.4 volatile
`volatile`å˜é‡ä¸ä¼šè¢«ç¼“å­˜åœ¨å¯„å­˜å™¨æˆ–è€…å…¶ä»–å¤„ç†å™¨ä¸å¯è§çš„åœ°æ–¹ï¼Œåœ¨è¯»å–`volatile`å˜é‡æ—¶ï¼Œæ€»æ˜¯è¿”å›æœ€æ–°å†™å…¥çš„å€¼ã€‚

ï¼ï¼ä¸å»ºè®®è¿‡åº¦ä¾èµ–`volatile`å˜é‡æä¾›çš„å¯è§æ€§ã€‚å¦‚æœåœ¨ä»£ç ä¸­ä¾èµ–volatileå˜é‡æ§åˆ¶çŠ¶æ€çš„å¯è§æ€§ï¼Œé€šå¸¸æ¯”ä½¿ç”¨é”çš„ä»£ç æ›´è„†å¼±ï¼Œä¹Ÿæ›´éš¾ç†è§£ã€‚

> ä»…å½“volatileå˜é‡èƒ½ç®€åŒ–ä»£ç å®ç°ä»¥åŠå¯¹åŒæ­¥ç­–ç•¥çš„éªŒè¯æ—¶ï¼Œæ‰åº”è¯¥ä½¿ç”¨ã€‚å¦‚æœåœ¨éªŒè¯æ­£ç¡®æ€§æ—¶ï¼Œéœ€è¦å¯¹å¯è§æ€§è¿›è¡Œå¤æ‚çš„åˆ¤æ–­ï¼Œå°±ä¸è¦ä½¿ç”¨volatileã€‚volatileå˜é‡çš„æ­£ç¡®ä½¿ç”¨æ–¹å¼åŒ…æ‹¬ï¼šç¡®ä¿ä»–ä»¬è‡ªèº«çŠ¶æ€çš„å¯è§æ€§ï¼Œç¡®ä¿ä»–ä»¬æ‰€å¼•ç”¨çš„å¯¹è±¡çš„è½§è¾Šå°çš„å¯è§æ€§ï¼Œä»¥åŠæ ‡è¯†ä¸€äº›é‡è¦çš„ç¨‹åºç”Ÿå‘½å‘¨æœŸäº‹ä»¶çš„å‘ç”Ÿï¼ˆä¾‹å¦‚åˆå§‹åŒ–æˆ–å…³é—­ï¼‰ã€‚

ä¸‹é¢è¿™ä¸ªä¾‹å­æ˜¯volatileçš„ç»å…¸ç”¨æ³•ï¼Œæ£€æŸ¥æŸä¸ªæ ‡è®°ä»¥åˆ¤æ–­æ˜¯å¦é€€å‡ºå¾ªç¯ã€‚å¦‚æœä½¿ç”¨é”ï¼Œä¼šæ˜¯çš„ä»£ç æ›´å¤æ‚ã€‚
```java
volatile boolean asleep;

...
	while (!asleep)
		countSomeSheep();
```

> åŠ é”æœºåˆ¶æ—¢å¯ä»¥ç¡®ä¿å¯è§æ€§ï¼Œåˆå¯ä»¥ç¡®ä¿åŸå­æ€§ï¼Œè€Œ`volatile`å˜é‡åªèƒ½ç¡®ä¿å¯è§æ€§ã€‚

å½“ä¸”ä»…å½“æ»¡è¶³ä¸‹åˆ—æ¡ä»¶æ—¶ï¼Œæ‰åº”è¯¥ä½¿ç”¨`volatile`å˜é‡ï¼š
- å¯¹å˜é‡çš„å†™å…¥æ“ä½œä¸ä¾èµ–å˜é‡çš„å½“å‰å€¼ï¼Œæˆ–è€…èƒ½ç¡®ä¿åªæœ‰å•ä¸ªçº¿ç¨‹æ›´æ–°å˜é‡çš„å€¼
- è¯¥å˜é‡ä¸ä¼šå’Œå…¶ä»–çŠ¶æ€å˜é‡ä¸€èµ·çº³å…¥ä¸å˜æ€§æ¡ä»¶ä¸­
- åœ¨è®¿é—®å˜é‡æ—¶ä¸éœ€è¦åŠ é”


### 3.5 å‘å¸ƒä¸é€¸å‡º(publish and escape)
- **å‘å¸ƒ**ä¸€ä¸ªå¯¹è±¡æ˜¯æŒ‡ä½¿å¯¹è±¡èƒ½åœ¨å½“å‰ä½œç”¨åŸŸä¹‹å¤–çš„ä»£ç ä¸­ä½¿ç”¨
- å½“æŸä¸ªä¸åº”è¯¥å‘å¸ƒçš„å¯¹è±¡è¢«å‘å¸ƒæ—¶ï¼Œå°±ç§°ä¸º**é€¸å‡º**

```java
class UnsafeStates{
	private String[] states = new String[] {"AL","AK"};
	public String[] getStates() { return states; }
}
```

UnsafeStatesçš„ä»»ä½•è°ƒç”¨è€…éƒ½èƒ½ä¿®æ”¹statesä¸­çš„å†…å®¹ï¼ï¼

> å¤–éƒ¨æ–¹æ³•ï¼šå¯¹ç±»Cæ¥è¯´ï¼Œè¡Œä¸ºå¹¶ä¸å®Œå…¨ç”±Cæ¥è§„å®šçš„æ–¹æ³•ï¼ŒåŒ…æ‹¬å…¶ä»–ç±»ä¸­å®šä¹‰çš„æ–¹æ³•ä»¥åŠç±»Cä¸­å¯ä»¥è¢«æ”¹å†™çš„æ–¹æ³•ï¼ˆæ—¢ä¸æ˜¯privateä¹Ÿä¸æ˜¯finalçš„æ–¹æ³•ï¼‰

å‘å¸ƒå¯¹è±¡çš„å‡ ç§æ–¹æ³•ï¼š
- å°†å¯¹è±¡çš„å¼•ç”¨ä¿å­˜åœ¨å…±æœ‰çš„é™æ€å˜é‡ä¸­
- å½“å‘å¸ƒä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œå¯¹è±¡çš„éç§æœ‰åŸŸä¸­å¼•ç”¨çš„å¯¹è±¡åŒæ ·ä¼šè¢«å‘å¸ƒ
- å‘å¸ƒä¸€ä¸ªå†…éƒ¨çš„ç±»å®ä¾‹ã€‚ï¼ˆéé™æ€å†…éƒ¨ç±»å¯¹éšå¼çš„å«æœ‰å¤–éƒ¨ç±»çš„thiså¼•ç”¨ï¼‰

æ„é€ æ–¹æ³•ç»å¸¸ä¼šå¯¼è‡´thiséšæ€§é€¸å‡ºã€‚å¦‚
```java
public class ThisEscape {
	public ThisEscape(EventSource eventSource) {
		source.registerListener(
            new EventListener(){
                public void onEvent(Event e) {
                    doSomething(e);
                }
            }
        )
	}
}
```

`ThisEscape`å‘å¸ƒEventSourceæ—¶ï¼Œä¹Ÿéšå«å‘å¸ƒäº†ThisEscapeå¯¹è±¡æœ¬èº«ï¼Œå› ä¸ºè¿™ä¸ªå†…éƒ¨ç±»çš„å®ä¾‹ä¸­åŒ…å«äº†å¯¹ThisEscapeå®ä¾‹çš„éšå¼å¼•ç”¨ã€‚

> ä¸è¦åœ¨æ„é€ å‡½æ•°ä¸­ä½¿thiså¼•ç”¨é€¸å‡ºã€‚ï¼ˆåªæœ‰æ„é€ å‡½æ•°è¿”å›æ—¶ï¼Œthiså¼•ç”¨æ‰åº”è¯¥ä»çº¿ç¨‹ä¸­é€¸å‡ºï¼‰

- åœ¨æ„é€ å‡½æ•°ä¸­åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œæ— è®ºæ˜¯æ˜¾å¼ï¼ˆä¼ å…¥çº¿ç¨‹ï¼‰åˆ›å»ºè¿˜æ˜¯éšå¼ï¼ˆå¯¹è±¡çš„å†…éƒ¨ç±»ï¼‰åˆ›å»ºï¼Œthiså¼•ç”¨éƒ½ä¼šè¢«è¯¥çº¿ç¨‹å…±äº«ã€‚åœ¨æ„é€ å‡½æ•°ä¸­åˆ›å»ºçº¿ç¨‹æ²¡æœ‰é—®é¢˜ï¼Œä½†æœ€å¥½ä¸è¦ç«‹å³å¯åŠ¨ä»–ï¼Œè€Œæ˜¯é€šè¿‡startæˆ–initializeæ–¹æ³•æ¥å¯åŠ¨ã€‚
- åœ¨æ„é€ å‡½æ•°è°ƒç”¨ä¸€ä¸ªå¯æ”¹å†™çš„å®ä¾‹æ–¹æ³•ï¼ˆéprivate/finalæ–¹æ³•ï¼‰åŒæ ·ä¼šä½¿å¾—thisåœ¨æ„é€ è¿‡ç¨‹é€¸å‡ºã€‚

å¦‚æœæƒ³åœ¨æ„é€ å‡½æ•°ä¸­æ³¨å†Œä¸€ä¸ªäº‹ä»¶ç›‘å¬å™¨æˆ–å¯åŠ¨çº¿ç¨‹ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨ä¸€ä¸ªç§æœ‰çš„æ„é€ å‡½æ•°å’Œä¸€ä¸ªå…¬æœ‰çš„å·¥å‚æ–¹æ³•æ¥é¿å…ä¸æ­£ç¡®çš„æ„é€ è¿‡ç¨‹ã€‚

```java
public class SafeListener {
    private final EventListener listener;

    private SafeListener() {
        listenr = new EventListener() {
            public void onEvent(Event e) {
                doSomething(e);
            }
        };
    }

    public static SafeListener newInstance(EventSource source) {
        SafeListener safe = new SafeListener();
        source.registerListener(safe.listener);
        return safe;
    }
}
```


### 3.6 çº¿ç¨‹å°é—­ï¼ˆThread Confinementï¼‰
ä»…åœ¨å•ä¸ªçº¿ç¨‹å†…è®¿é—®æ•°æ®ï¼Œå°±ä¸éœ€è¦åŒæ­¥ï¼Œè¿™å°±æ˜¯**çº¿ç¨‹å°é—­**

å¦‚ï¼šJDBCçš„Connectionå¯¹è±¡å°±æ˜¯çº¿ç¨‹å°é—­æŠ€æœ¯çš„ä¸€ç§åº”ç”¨ã€‚

> JAVAè¯­è¨€æ²¡æ³•å¼ºåˆ¶å°†å¯¹è±¡å°é—­åœ¨æŸä¸ªçº¿ç¨‹ä¸­ã€‚åªæ˜¯æä¾›äº†ä¸€äº›æœºåˆ¶æ¥å¸®åŠ©ç»´æŒçº¿ç¨‹çš„å°é—­æ€§ï¼Œä¾‹å¦‚å±€éƒ¨å˜é‡å’ŒThreadLocalç±»ã€‚ä½†æ˜¯ï¼Œä»ç„¶ç”±ç¨‹åºå‘˜è‡ªå·±ç¡®ä¿çº¿ç¨‹ä¸­çš„å¯¹è±¡ä¸ä¼šé€¸å‡ºã€‚

#### Ad-hocçº¿ç¨‹å°é—­
Ad-hocçº¿ç¨‹å°é—­æ˜¯æŒ‡ï¼Œç»´æŠ¤çº¿ç¨‹å°é—­æ€§çš„èŒè´£å®Œå…¨ç”±ç¨‹åºå®ç°æ¥æ‰¿æ‹…ã€‚

#### æ ˆå°é—­
æ ˆå°é—­æ˜¯çº¿ç¨‹å°é—­çš„ä¸€ç§ç‰¹ä¾‹ï¼Œåœ¨æ ˆå°é—­ä¸­ï¼Œåªèƒ½é€šè¿‡å±€éƒ¨å˜é‡æ‰èƒ½è®¿é—®å¯¹è±¡ã€‚

#### ThreadLocalç±»
ThreadLocalæä¾›äº†getã€setæ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•ä¸ºæ¯ä¸ªä½¿ç”¨æ”¹å˜é‡çš„çº¿ç¨‹éƒ½æœ‰ä¸€ä»½ç‹¬ç«‹çš„å‰¯æœ¬ï¼Œå› æ­¤getæ€»æ˜¯è¿”å›ç”±å½“å‰çº¿ç¨‹åœ¨è°ƒç”¨setè®¾ç½®çš„æœ€æ–°å€¼ã€‚ThreadLocalå¯¹è±¡é€šå¸¸ç”¨äºé˜²æ­¢å¯¹å¯å˜çš„å•å®ä¾‹å˜é‡æˆ–å…¨å±€å˜é‡è¿›è¡Œå…±äº«ã€‚

å¦‚æœéœ€è¦å°†ä¸€ä¸ªå•çº¿ç¨‹åº”ç”¨ç¨‹åºç§»æ¤åˆ°å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œé€šè¿‡å°†å…±äº«çš„å…¨å±€å˜é‡è½¬æ¢ä¸ºThreadLocalå¯¹è±¡ï¼Œå¯ä»¥ç»´æŒçº¿ç¨‹å®‰å…¨æ€§ã€‚

åº”ç”¨ç¨‹åºæ¡†æ¶ä¸­å¤§é‡ä½¿ç”¨äº†ThreadLocalã€‚å¦‚ï¼ŒEJBè°ƒç”¨æœŸé—´ï¼ŒJ2EEå®¹å™¨éœ€è¦å°†ä¸€ä¸ªäº‹åŠ¡ä¸Šä¸‹æ–‡ä¸æŸä¸ªçº¿ç¨‹å…³è”èµ·æ¥ã€‚é€šè¿‡å°†äº‹åŠ¡ä¸Šä¸‹æ–‡ä¿å­˜åœ¨é™æ€çš„ThreadLocalå¯¹è±¡ä¸­ï¼Œå¯ä»¥å¾ˆå®¹æ˜“çš„å®ç°è¿™ä¸ªåŠŸèƒ½ï¼šå½“æ¡†æ¶ä»£ç éœ€è¦åˆ¤æ–­å½“å‰è¿è¡Œçš„æ˜¯å“ªä¸ªäº‹åŠ¡æ—¶ï¼Œåªéœ€è¦ä»è¿™ä¸ªThreadLocalå¯¹è±¡ä¸­è¯»å–äº‹åŠ¡ä¸Šä¸‹æ–‡ã€‚

> ThreadLocalå˜é‡ç±»ä¼¼äºå…¨å±€å˜é‡ï¼Œä»–ä¼šé™ä½ä»£ç çš„å¯é‡ç”¨æ€§å¹¶åœ¨ç±»ä¹‹é—´å¼•å…¥éšå«çš„è€¦åˆæ€§ï¼Œåœ¨ä½¿ç”¨æ—¶è¦æ ¼å¤–å°å¿ƒã€‚

### 3.7 ä¸å˜æ€§
æ»¡è¶³åŒæ­¥éœ€æ±‚çš„å¦ä¸€ç§åŠæ³•æ˜¯ä½¿ç”¨ä¸å¯å˜å¯¹è±¡ã€‚ä¸å¯å˜å¯¹è±¡ä¸€å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚

å½“æ»¡è¶³ä»¥ä¸‹æ¡ä»¶æ—¶ï¼Œå¯¹è±¡æ‰æ˜¯ä¸å¯å˜çš„ï¼š
- å¯¹è±¡åˆ›å»ºåå…¶çŠ¶æ€å°±ä¸èƒ½ä¿®æ”¹
- å¯¹è±¡çš„æ‰€æœ‰åŸŸéƒ½æ˜¯finalç±»å‹ï¼ˆæŠ€æœ¯ä¸Šä¸ä¸€å®šï¼Œå¦‚Stringï¼‰
- å¯¹è±¡æ˜¯æ­£ç¡®åˆ›å»ºçš„ï¼ˆæ„é€ æ—¶ï¼Œthisæ²¡æœ‰é€¸å‡ºï¼‰

> é™¤ééœ€è¦æŸä¸ªåŸŸæ˜¯å¯å˜çš„ï¼Œå¦åˆ™åº”å°†å…¶å£°æ˜ä¸ºfinalåŸŸã€‚

æ¯å½“éœ€è¦å¯¹ä¸€ç»„ç›¸å…³æ•°æ®ä»¥åŸå­æ–¹å¼æ‰§è¡ŒæŸä¸ªæ“ä½œæ—¶ï¼Œå°±å¯ä»¥è€ƒè™‘åˆ›å»ºä¸€ä¸ªä¸å¯å˜ç±»æ¥åŒ…å«è¿™äº›æ•°æ®ã€‚å¦‚ä¸‹ï¼š

```java
@Immutable
class OneValueCache {
    private final BigInteger lastNumber;
    private final BigInteger lastFactors;

    public OneValueCache(BigInteger i, BigInteger[] factors) {
        lastNumber = i;
        lastFactors = Arrays.copyOf(factors, factors.length);
    }

    public BigInteger[] getFactors(BigInteger i) {
        if (lastNumber == null || !lastNumber.equals(i))
            return null;
        else
            return Arrays.copyOf(lastFactors, lastFactors.length);
    }
}

```

### 3.8 å®‰å…¨å‘å¸ƒ
å‰é¢å‡ èŠ‚æ˜¯å…³äºå¦‚ä½•ç¡®ä¿å¯¹è±¡ä¸è¢«å‘å¸ƒï¼Œè¿™ä¸€èŠ‚æ˜¯å…³äºå¦‚ä½•å®‰å…¨å‘å¸ƒï¼Œå®‰å…¨çš„åœ¨å¤šä¸ªçº¿ç¨‹é—´å…±äº«å¯¹è±¡ã€‚

#### ä¸æ­£ç¡®å‘å¸ƒçš„ä¾‹å­
```java
public class Holder {
    private int n;
    public Holder(int n) { this.n = n; }
    public void assertSanity() {
        // æœ‰å¯èƒ½ä¼šæŠ›å‡ºå¼‚å¸¸
        if (n!=n)
            throw new AssertionError("This statement is false.");
    }
}
```

ç”±äºæ²¡æœ‰ä½¿ç”¨åŒæ­¥æ¥ç¡®ä¿Holderå¯¹è±¡å¯¹å…¶ä»–çº¿ç¨‹å¯è§ï¼Œå› æ­¤Holderå¯¹è±¡æœªè¢«æ­£ç¡®å‘å¸ƒã€‚

#### ä¸å¯å˜å¯¹è±¡
ä»»ä½•çº¿ç¨‹éƒ½å¯ä»¥åœ¨ä¸éœ€è¦é¢å¤–åŒæ­¥çš„æƒ…å†µä¸‹å®‰å…¨åœ°è®¿é—®ä¸å¯å˜å¯¹è±¡ï¼Œå³ä½¿åœ¨å‘å¸ƒè¿™äº›å¯¹è±¡æ—¶æ²¡æœ‰ä½¿ç”¨åŒæ­¥ã€‚

å¦‚æœfinalç±»å‹çš„åŸŸæ‰€æŒ‡å‘çš„æ˜¯å¯å˜å¯¹è±¡ï¼Œé‚£ä¹ˆåœ¨è®¿é—®è¿™äº›åŸŸæ‰€æŒ‡å‘çš„å¯¹è±¡çš„çŠ¶æ€æ—¶ä»ç„¶éœ€è¦åŒæ­¥ã€‚

#### å®‰å…¨å‘å¸ƒçš„å¸¸ç”¨æ¨¡å¼
ä¸‹é¢ä»‹ç»çš„å®‰å…¨å‘å¸ƒä¸»è¦åœ¨äºå¯¹è±¡å‘å¸ƒåçš„å¯è§æ€§åŠå¯¹å¯è§æ€§ä¿®æ”¹ã€‚

è¦å®‰å…¨çš„å‘å¸ƒä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹è±¡çš„å¼•ç”¨åŠçŠ¶æ€å¿…é¡»åŒæ—¶å¯¹å…¶ä»–çº¿ç¨‹å¯è§ã€‚ä¸€ä¸ªæ­£ç¡®æ„é€ çš„å¯¹è±¡å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼å®‰å…¨å‘å¸ƒï¼š
- åœ¨é™æ€åˆå§‹åŒ–å‡½æ•°ä¸­åˆå§‹åŒ–ä¸€ä¸ªå¯¹è±¡å¼•ç”¨ï¼ˆ`private static Holder holder = new Holder(42);`ï¼‰
  - é™æ€åˆå§‹åŒ–å™¨ç”±JVMåœ¨ç±»çš„åˆå§‹åŒ–é˜¶æ®µæ‰§è¡Œã€‚ç”±äºåœ¨JVMå†…éƒ¨å­˜åœ¨åŒæ­¥æœºåˆ¶ï¼Œé€šè¿‡è¿™ç§æ–¹å¼åˆå§‹åŒ–çš„å¯¹è±¡éƒ½å¯ä»¥å®‰å…¨å‘å¸ƒã€‚
- å°†å¯¹è±¡çš„å¼•ç”¨ä¿å­˜åœ¨volatileæˆ–è€…AtomicReferanceå¯¹è±¡ä¸­
- å°†å¯¹è±¡çš„å¼•ç”¨ä¿å­˜åœ¨æŸä¸ªæ­£ç¡®æ„é€ å¯¹è±¡çš„finalåŸŸä¸­
- å°†å¯¹è±¡çš„å¼•ç”¨ä¿å­˜åœ¨ä¸€ä¸ªç”±é”ä¿æŠ¤çš„åŸŸä¸­ï¼ˆå¦‚çº¿ç¨‹å®‰å…¨å®¹å™¨ï¼ŒsynchronizedListç­‰ï¼‰

> åœ¨æ²¡æœ‰é¢å¤–åŒæ­¥çš„æƒ…å†µä¸‹ï¼Œä»»ä½•çº¿ç¨‹éƒ½å¯ä»¥å®‰å…¨çš„ä½¿ç”¨è¢«å®‰å…¨å‘å¸ƒçš„äº‹å®ä¸å¯å˜å¯¹è±¡ã€‚

#### å¯å˜å¯¹è±¡
å¯¹è±¡å‘å¸ƒçš„éœ€æ±‚å–å†³äºä»–çš„å¯å˜æ€§ï¼š
- ä¸å¯å˜å¯¹è±¡å¯ä»¥é€šè¿‡ä»»æ„æœºåˆ¶å‘å¸ƒ
- äº‹å®ä¸å¯å˜å¯¹è±¡å¿…é¡»é€šè¿‡å®‰å…¨æ–¹å¼å‘å¸ƒ
- å¯å˜å¯¹è±¡å¿…é¡»é€šè¿‡å®‰å…¨æ–¹å¼å‘å¸ƒï¼Œå¹¶ä¸”å¿…é¡»æ˜¯çº¿ç¨‹å®‰å…¨çš„æˆ–è€…ç”±æŸä¸ªé”ä¿æŠ¤èµ·æ¥ã€‚

#### å®‰å…¨çš„å…±äº«å¯¹è±¡
åœ¨å¹¶å‘ç¨‹åºæ±‡æ€»ä½¿ç”¨å’Œå…±äº«å¯¹è±¡æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ä¸€äº›ç­–ç•¥ï¼š
- **çº¿ç¨‹å°é—­**  çº¿ç¨‹å°é—­çš„å¯¹è±¡åªèƒ½ç”±ä¸€ä¸ªçº¿ç¨‹æ‹¥æœ‰ï¼Œåªèƒ½ç”±è¯¥çº¿ç¨‹ä¿®æ”¹ã€‚
- **åªè¯»å…±äº«**  åœ¨æ²¡æœ‰é¢å¤–åŒæ­¥çš„æƒ…å†µä¸‹ï¼Œå…±äº«çš„åªè¯»å¯¹è±¡å¯ä»¥ç”±å¤šä¸ªçº¿ç¨‹å¹¶å‘è®¿é—®ï¼Œä½†ä»»ä½•çº¿ç¨‹éƒ½ä¸èƒ½ä¿®æ”¹ã€‚å…±äº«çš„åªè¯»å¯¹è±¡åŒ…æ‹¬ä¸å¯å˜å¯¹è±¡å’Œäº‹å®ä¸å¯å˜å¯¹è±¡ã€‚
- **çº¿ç¨‹å®‰å…¨å…±äº«**  çº¿ç¨‹å®‰å…¨çš„å¯¹è±¡åœ¨å…¶å†…éƒ¨å®ç°åŒæ­¥ï¼Œå› æ­¤å¤šä¸ªçº¿ç¨‹å¯¹è±¡å¯ä»¥é€šè¿‡å¯¹è±¡çš„å…¬æœ‰æ¥å£æ¥è¿›è¡Œè®¿é—®è€Œä¸éœ€è¦è¿›ä¸€æ­¥åŒæ­¥ã€‚
- **ä¿æŠ¤å¯¹è±¡**  è¢«ä¿æŠ¤çš„å¯¹è±¡åªèƒ½é€šè¿‡æŒæœ‰ç‰¹å®šçš„é”æ¥è®¿é—®ã€‚ä¿æŠ¤å¯¹è±¡åŒ…æ‹¬å°è£…åœ¨å…¶ä»–çº¿ç¨‹å®‰å…¨å¯¹è±¡ä¸­çš„å¯¹è±¡ï¼Œä»¥åŠå·²å‘å¸ƒçš„å¹¶ä¸”ç”±æŸä¸ªç‰¹å®šé”ä¿æŠ¤çš„å¯¹è±¡ã€‚


## å››ã€å¯¹è±¡çš„ç»„åˆ
### 4.1 è®¾è®¡çº¿ç¨‹å®‰å…¨çš„ç±»
åœ¨è®¾è®¡çº¿ç¨‹å®‰å…¨ç±»çš„è¿‡ç¨‹ä¸­ï¼Œéœ€è¦åŒ…å«ä»¥ä¸‹ä¸‰ä¸ªè¦ç´ ï¼š
- æ‰¾å‡ºæ„æˆå¯¹è±¡çŠ¶æ€çš„æ‰€æœ‰å˜é‡
- æ‰¾å‡ºçº¦æŸçŠ¶æ€å˜é‡çš„ä¸å˜æ€§æ¡ä»¶
- å»ºç«‹å¯¹è±¡çŠ¶æ€çš„å¹¶å‘ç®¡ç†ç­–ç•¥

åŒæ­¥ç­–ç•¥ å®šä¹‰äº†å¦‚ä½•åœ¨ä¸è¿èƒŒå¯¹è±¡ä¸å˜æ¡ä»¶æˆ–åéªŒæ¡ä»¶çš„æƒ…å†µä¸‹å¯¹å…¶çŠ¶æ€çš„è®¿é—®æ“ä½œè¿›è¡ŒååŒ

### 4.2 å®ä¾‹å°é—­
å°†å¯¹è±¡å°è£…åœ¨å¯¹è±¡å†…éƒ¨ï¼Œå¯ä»¥å°†æ•°æ®çš„è®¿é—®é™åˆ¶åœ¨å¯¹è±¡çš„æ–¹æ³•ä¸Šï¼Œä»è€Œæ›´å®¹æ˜“ç¡®ä¿çº¿ç¨‹åœ¨è®¿é—®æ•°æ®æ—¶æ€»èƒ½æŒæœ‰æ­£ç¡®çš„é”ã€‚

è¢«å°é—­çš„å¯¹è±¡ä¸€å®šä¸èƒ½è¶…å‡ºä»–ä»¬çš„æ—¢å®šä½œç”¨åŸŸã€‚

> å½“å‘å¸ƒå…¶ä»–å¯¹è±¡æ—¶ï¼Œä¾‹å¦‚è¿­ä»£å™¨æˆ–å†…éƒ¨ç±»å®ä¾‹ï¼Œå¯èƒ½ä¼šé—´æ¥å‘å¸ƒè¢«å°é—­çš„å¯¹è±¡ï¼ŒåŒæ ·ä¼šä½¿å°é—­å¯¹è±¡é€¸å‡º


ï¼ï¼ä½¿ç”¨**ç§æœ‰çš„é”å¯¹è±¡**ï¼Œè€Œä¸æ˜¯å¯¹è±¡çš„å†…ç½®é”ï¼ˆæˆ–å…¶ä»–å¯é€šè¿‡å…¬æœ‰æ–¹å¼è®¿é—®çš„é”ï¼‰ï¼Œæœ‰è®¸å¤šä¼˜ç‚¹ã€‚ç§æœ‰çš„é”å¯¹è±¡å¯ä»¥å°†å¯¹è±¡å°è£…èµ·æ¥ï¼Œä½¿å®¢æˆ·ç«¯æ— æ³•å¾—åˆ°é”ï¼Œä½†å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡å…¬æœ‰æ–¹æ³•è®¿é—®é”ï¼Œä»¥ä¾¿å‚ä¸åˆ°ä»–çš„åŒæ­¥ç­–ç•¥ä¸­ã€‚å¦‚æœå®¢æˆ·ä»£ç é”™è¯¯çš„è·å¾—äº†å¦ä¸€ä¸ªå¯¹è±¡çš„é”ï¼Œå¯èƒ½ä¼šäº§ç”Ÿæ´»è·ƒæ€§é—®é¢˜ã€‚åŒæ—¶ï¼Œæƒ³è¦éªŒè¯æŸä¸ªå…¬æœ‰è®¿é—®çš„é”åœ¨ç¨‹åºæ±‡æ€»æ˜¯å¦è¢«æ­£ç¡®çš„ä½¿ç”¨ï¼Œéœ€è¦æ£€æŸ¥æ•´ä¸ªç¨‹åºè€Œä¸æ˜¯å•ä¸ªç±»ã€‚

> Javaç›‘è§†å™¨æ¨¡å¼ï¼šè¿›å…¥å’Œé€€å‡ºåŒæ­¥ä»£ç å—çš„å­—èŠ‚æŒ‡ä»¤è¢«ç§°ä¸ºmonitorenterå’Œmonitorexitï¼Œè€ŒJavaçš„å†…ç½®é”ä¹Ÿç§°ä¸ºç›‘è§†å™¨é”æˆ–ç›‘è§†å™¨ã€‚

### 4.3 çº¿ç¨‹å®‰å…¨çš„å§”æ‰˜
å°†éçº¿ç¨‹å®‰å…¨çš„å¯¹è±¡å§”æ‰˜ç»™çº¿ç¨‹å®‰å…¨çš„å¯¹è±¡ç®¡ç†ã€‚å¦‚æ™®é€šçš„listå§”æ‰˜ç»™`CopyOnWriteArrayList`ã€‚

å¦‚æœç±»ä¸­å„ç»„ä»¶éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œè¿™ä¸ªç±»ä¸ä¸€å®šçº¿ç¨‹å®‰å…¨ã€‚

1. å°†ä¸€ä¸ªçŠ¶æ€å§”æ‰˜ç»™çº¿ç¨‹å®‰å…¨çš„ç±»ï¼ˆmapå§”æ‰˜ç»™ConcurrentHashMapï¼‰
```java
@Immutable
public class Point {
    public final int x, y;

    public Point(int x, int y) {
        this.x = x;
        this.y = y;
    }
}

/**
* ä¿å­˜æ‰€æœ‰è½¦è¾†çš„ä½ç½®
* unmodifiableMapè¿”å›locationsçš„ä¸€ä¸ªå®æ—¶æ‹·è´ï¼ˆviewè§†å›¾ï¼‰
*/
@ThreadSafe
public class DelegatingVehicleTracker {
    private final ConcurrentMap<String, Point> locations;
    private final Map<String, Point> unmodifiableMap;

    public DelegatingVehicleTracker(Map<String, Point> points) {
        locations = new ConcurrentHashMap<String, Point>(points);
        unmodifiableMap = collections.unmodifiableMap(locations);
    }

    public Map<String, Point> getLocations() {
        return unmodifiableMap;
    }

    public Point getLocation(String id) {
        return locations.get(id);
    }

    public void setLocation(String id, int x, int y) {
        if (locations.replace(id, new Point(x, y)) == null) 
            throw new IllegalArgumentException("invalid vehicle name: "+id);
    }
}
```

2. å°†**ç›¸äº’ç‹¬ç«‹çš„çŠ¶æ€**å§”æ‰˜ä¸ºä¸€ä¸ªç±»ä¸­ä¸åŒçš„çº¿ç¨‹å®‰å…¨çš„å¯¹è±¡

å¦‚æœä¸€ä¸ªç±»æ˜¯ç”±å¤šä¸ªç‹¬ç«‹ä¸”çº¿ç¨‹å®‰å…¨çš„çŠ¶æ€å˜é‡ç»„æˆï¼Œå¹¶ä¸”åœ¨æ‰€æœ‰çš„æ“ä½œä¸­éƒ½ä¸åŒ…å«æ— æ•ˆçš„è½¬æ¢ï¼Œé‚£ä¹ˆå¯ä»¥å°†çº¿ç¨‹å®‰å…¨æ€§å§”æ‰˜ç»™åº•å±‚çš„çŠ¶æ€å˜é‡

å¦‚æœä¸€ä¸ªçŠ¶æ€å˜é‡æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¹¶ä¸”æ²¡æœ‰ä»»ä½•ä¸å˜å½¢æ¡ä»¶çº¦æŸä»–çš„å€¼ï¼Œåœ¨å˜é‡çš„æ“ä½œä¸Šä¹Ÿä¸å­˜åœ¨ä»»ä½•ä¸å…è®¸çš„çŠ¶æ€è½¬æ¢ï¼Œé‚£ä¹ˆå°±å¯ä»¥å®‰å…¨çš„å‘å¸ƒè¿™ä¸ªå˜é‡ã€‚å‰é¢çš„DelegatingVehicleTrackerå¦‚æœPointæ›´æ”¹ä¸ºçº¿ç¨‹å®‰å…¨çš„Pointï¼Œå°±å¯ä»¥å®‰å…¨çš„å‘å¸ƒPointè®©ç”¨æˆ·ä¿®æ”¹ã€‚


### 4.4 åœ¨ç°æœ‰çš„çº¿ç¨‹å®‰å…¨ç±»ä¸­å¢åŠ åŠŸèƒ½

```java
@ThreadSafe
public class BetterVector<E> extends Vector<E> {
    public synchonized boolean putIfAbsent(E x) {
        boolean absent = !contains(x);
        if (absent)
            add(x);
        return absent;
    }
}
```

è¦ä½¿å®¢æˆ·ç«¯åŠ é”ï¼Œå¿…é¡»è¦çŸ¥é“å¯¹è±¡Xä½¿ç”¨çš„æ˜¯å“ªä¸ªé”ã€‚
```java
@NotThreadSafe
public class ListHelper<E> {
    public List<E> list = Collections.synchronizedList(new ArrayList<E>());

    ...
    public synchronized boolean putIfAbsent(E x) {
        boolean absent = !list.contains(x);
        if (absent)
            add(x);
        return absent;
    }
}

@ThreadSafe
public class ListHelper<E> {
    public List<E> list = Collections.synchronizedList(new ArrayList<E>());

    ...
    public boolean putIfAbsent(E x) {
        synchronized (list) {
            boolean absent = !list.contains(x);
            if (absent)
                add(x);
            return absent;
        }
    }
```

å½“ä¸ºç°æœ‰çš„ç±»å¢åŠ ä¸€ä¸ªåŸå­æ“ä½œæ—¶ï¼Œæ›´å¥½çš„æ–¹æ³•æ˜¯**ç»„åˆ**ã€‚
```java
@ThreadSafe
public class ImprovedList<T> implement List<T> {
    private final List<T> list;

    public ImprovedList(List<T> list) {
        this.list = list;
    }

    public synchronized boolean putIfAbsent(T x) {
        boolean absent = !list.contains(x);
        if (absent)
            add(x);
        return absent;
    }

    public synchronized void clear() {
        list.clear();
    }

    // ...ç±»ä¼¼clearå§”æ‰˜å…¶ä»–æ–¹
}
```


### 4.5 å°†åŒæ­¥ç­–ç•¥æ–‡æ¡£åŒ–
å¦‚æœæŸä¸ªç±»æ²¡æœ‰æ˜ç¡®å£°æ˜ä»–æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå°±ä¸è¦å‡è®¾ä»–æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚


## äº”ã€åŸºç¡€æ„å»ºæ¨¡å—
### 5.1 åŒæ­¥å®¹å™¨ç±»
åŒæ­¥å®¹å™¨ç±»åŒ…æ‹¬Vectorã€Hashtableä»¥åŠç”±Collections.synchronizedXxxç­‰å·¥å‚æ–¹æ³•åˆ›å»ºçš„ç±»ã€‚è¿™äº›ç±»éƒ½æ˜¯é€šè¿‡å¯¹æ¯ä¸ªå…¬æœ‰æ–¹æ³•åŠæ€§èƒ½åŒæ­¥å®ç°çš„çº¿ç¨‹å®‰å…¨ã€‚

åŒæ­¥ç±»çš„é—®é¢˜ï¼šå¤åˆæ“ä½œå¯èƒ½äº§ç”Ÿæ„æ–™ä¹‹å¤–çš„è¡Œä¸ºã€‚
```java
// å¯èƒ½äº§ç”Ÿå¼‚å¸¸çš„æ–¹æ³•
public static Object getLast(Vector list) {
    int lastIndex = list.size() - 1;
    return list.get(lastIndex); //å¯èƒ½å·²ç»é€šè¿‡removeæ–¹æ³•ç§»é™¤äº†lastIndexä½ç½®çš„å…ƒç´ ã€‚
}

// ä¿®æ”¹çš„æ–¹æ³•
public static Object getLast(Vector list) {
    synchronized(list) {
        int lastIndex = list.size() - 1;
        return list.get(lastIndex); //å¯èƒ½å·²ç»é€šè¿‡removeæ–¹æ³•ç§»é™¤äº†lastIndexä½ç½®çš„å…ƒç´ ã€‚
    }
}
```

### 5.2 å¹¶å‘å®¹å™¨
Java5.0æä¾›äº†å¤šç§**å¹¶å‘å®¹å™¨**æ¥æ”¹å–„çš„åŒæ­¥å®¹å™¨çš„æ€§èƒ½ã€‚é€šè¿‡å¹¶å‘å®¹å™¨æ¥ä»£æ›¿åŒæ­¥å®¹å™¨ï¼Œå¯ä»¥æå¤§çš„æé«˜ä¼¸ç¼©æ€§å¹¶é™ä½é£é™©ã€‚
- `ConcurrentHashMap`æ›¿ä»£åŒæ­¥ä¸”åŸºäºæ•£åˆ—çš„`Map`
- `CopyOnWriteArrayList`ç”¨äºæ›¿ä»£éå†æ“ä½œä¸ºä¸»è¦æ“ä½œçš„`List`
- `BlockingQueue`åœ¨Queueçš„åŸºç¡€ä¸Šæ‰©å±•äº†å¯é˜»å¡çš„æ’å…¥å’Œè·å–æ“ä½œã€‚å¦‚æœé˜Ÿåˆ—ä¸ºç©ºï¼Œé‚£è·å–æ“ä½œä¼šä¸€ç›´é˜»å¡ï¼Œç›´åˆ°å‡ºç°å¯ç”¨å…ƒç´ ã€‚
- `ConcurrentSkipListMap`å’Œ`ConcurrentSkipListSet`åˆ†è´ä½œä¸ºåŒæ­¥çš„`SortedMap`å’Œ`SortedSet`çš„æ›¿ä»£ã€‚

#### ConcurrentHashMap
ConcurrentHashMapä½¿ç”¨åˆ†æ®µé”ï¼ˆLock Stripingï¼‰è¿›è¡ŒåŠ é”ã€‚

> å…è®¸sizeæ–¹æ³•è¿”å›ä¸€ä¸ªè¿‘ä¼¼å€¼è€Œä¸æ˜¯ä¸€ä¸ªç²¾ç¡®å€¼ã€‚

ConcurrentHashMapå®ç°äº†ConcurrentMapæ¥å£ï¼Œæ¥å£ä¸­åŒ…å«ä¸€äº›å¸¸è§çš„å¤åˆæ“ä½œ: putIfAbsentã€removeIfEqualã€ReplaceIfEqualç­‰ã€‚

### 5.3 é˜»å¡é˜Ÿåˆ—
BlockingQueueæä¾›äº†å¯é˜»å¡çš„putå’Œtakeæ–¹æ³•ï¼Œä»¥åŠæ”¯æŒå®šæ—¶çš„offerå’Œpollã€‚

åŒç«¯é˜Ÿåˆ—é€‚ç”¨äºå·¥ä½œå¯†å–ï¼ˆWork Stealingï¼‰ã€‚æ‰€æœ‰æ¶ˆè´¹è€…æœ‰å„è‡ªçš„åŒç«¯é˜Ÿåˆ—ï¼Œå¦‚æœä¸€ä¸ªæ¶ˆè´¹è€…å®Œæˆäº†è‡ªå·±åŒç«¯é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œå¯ä»¥ä»å…¶ä»–æ¶ˆè´¹è€…åŒç«¯é˜Ÿåˆ—çš„æœ«å°¾çªƒå–å·¥ä½œã€‚

åŒç«¯é˜Ÿåˆ—çš„å®ç°ï¼šArrayDequeå’ŒLinkedBlockingDeque

### 5.4 åŒæ­¥å·¥å…·ç±»
é˜»å¡é˜Ÿåˆ—ã€é—­é”ã€ä¿¡å·é‡ã€æ …æ ï¼ˆbarrierï¼‰

#### é—­é”ï¼ˆLatchï¼‰
é—­é”æ˜¯ä¸€ç§åŒæ­¥å·¥å…·ç±»ï¼Œå¯ä»¥å»¶è¿Ÿçº¿ç¨‹çš„è¿›åº¦ç›´åˆ°å…¶è¾¾åˆ°ç»ˆæ­¢çŠ¶æ€ã€‚é—­é”çš„ä½œç”¨ç›¸å½“äºä¸€æ‰‡é—¨ï¼šåœ¨é—­é”åˆ°è¾¾ç»“æŸçŠ¶æ€ä¹‹å‰ï¼Œè¿™æ‰‡é—¨ä¸€ç›´æ˜¯å…³é—­çš„ï¼Œå¹¶ä¸”æ²¡æœ‰ä»»ä½•çº¿ç¨‹èƒ½é€šè¿‡ï¼Œå½“åˆ°è¾¾ç»“æŸçŠ¶æ€æ—¶ï¼Œè¿™æ‰‡é—¨ä¼šæ‰“å¼€å¹¶å…è®¸æ‰€æœ‰çš„çº¿ç¨‹é€šè¿‡ã€‚å½“é—­é”åˆ°è¾¾æ´»åŠ¨çŠ¶æ€åï¼Œå°†ä¸ä¼šæ”¹å˜çŠ¶æ€ï¼Œå› ä¸ºè¿™æ‰‡é—¨å°†æ°¸è¿œæ‰“å¼€ä¸‹å»ã€‚

ç”¨é€”ï¼šç¡®ä¿æŸä¸ªè®¡ç®—åœ¨å…¶æ‰€æœ‰éœ€è¦çš„èµ„æºå‡†å¤‡å¥½åå†æ‰§è¡Œã€‚
```java
public class TestHarness {
    public long timeTasks(int nThreads, final Runnable task) {
        final CountDownLatch startGate = new CountDownLatch(1);
        final CountDownLatch endGate = new CountDownLatch(nThreads);

        for (int i = 0; i < nThreads; i++) {
            Thread t = new Thread() {
                public void run() {
                    try {
                        startGate.await();
                        try {
                            task.run();
                        } finally {
                            endGate.count();
                        }
                    } catch (InterruptedException ignored) {}
                }
            };
            t.start();
        }

        long start = System.nanoTime();
        startGate.countDown();
        endGate.await();
        long end = System.nanoTime();
        return end - start;
    }
}
```

#### FutureTask
FutureTaskè¡¨ç¤ºçš„è®¡ç®—æ˜¯é€šè¿‡Callableå®ç°çš„ï¼Œå¯ä»¥å¤„äºä¸‰ç§çŠ¶æ€ï¼šç­‰å¾…è¿è¡Œã€æ­£åœ¨è¿è¡Œã€è¿è¡Œå®Œæˆã€‚å½“è¿è¡Œå®Œæˆåï¼Œå°†æ°¸è¿œåœåœ¨è¿™ä¸ªçŠ¶æ€ã€‚

FutureTask-ã€‹å¼‚æ­¥æ‰§è¡Œä»»åŠ¡
```java
public class PreLoader {
    private final FutureTask<ProductInfo> future = 
        new FutureTask<ProductInfo>(new Callable<ProductInfo>() {
            public ProductInfo call() throws DataLoadException {
                return loadProductInfo();
            }
        });
    private final Thread thread = new Thread(future);

    public void start() {
        thread.start();
    }

    public ProductInfo get() throws DataLoadException, InterruptedException {
        try {
            return future.get();
        } catch (ExecutionException e) {
            Throwable cause = e.getCause();
            if (cause instanceof DataLoadException)
                throw (DataLoadException) cause;
            else
                throw launderThrowable(cause);
        }
    }
    // å¦‚æœThrowableæ˜¯Errorï¼ŒæŠ›å‡ºå®ƒã€‚å¦‚æœæ˜¯RuntimeExceptionï¼Œè¿”å›ä»–ï¼Œå¦åˆ™æŠ›å‡ºIllegalStateException
    public static RuntimeException launderThrowable(Throwable t) {
        if (t instanceof RuntimeException)
            return (RuntimeException) t
        else if (t instanceof Error)
            throw (Error) t
        else
            throw new IllegalArgumentException("Not unchecked", e);
    }
}
```

> åœ¨æ„é€ å‡½æ•°æˆ–é™æ€åˆå§‹åŒ–æ–¹æ³•ä¸­å¯åŠ¨çº¿ç¨‹å¹¶ä¸æ˜¯ä»€ä¹ˆå¥½æ–¹æ³•

#### ä¿¡å·é‡ï¼ˆSemaphoreï¼‰
è®¡æ•°ä¿¡å·é‡ç”¨æ¥æ§åˆ¶åŒæ—¶è®¿é—®æŸä¸ªç‰¹å®šèµ„æºï¼ˆæˆ–åŒæ—¶æ‰§è¡ŒæŸä¸ªæ“ä½œï¼‰çš„æ“ä½œæ•°é‡ã€‚

```java
//ç»™å®¹å™¨è®¾ç½®è¾¹ç•Œ
public class BoundedHashSet<T> {
    private final Set<T> set;
    private final Semaphore sem;

    public BoundedHashSet(int bound) {
        this.set = Collections.synchronizedSet(new HashSet<T>());
        sem = new Semaphore(bound);
    }

    public boolean add(T o) throws InterruptedException {
        sem.acquire();
        boolean wasAdded = false;
        try {
            wasAdded = set.add(o);
            return wasAdded;
        } finally {
            if (!wasAdded)
                sem.release();
        }
    }

    public boolean remove(Object o) {
        boolean wasRemoved = set.remove(o);
        if (wasRemoved)
            sem.release();
        return wasRemoved;
    }
}

```



#### æ …æ ï¼ˆBarrierï¼‰
æ …æ èƒ½é˜»å¡ä¸€ç»„çº¿ç¨‹ï¼Œç›´åˆ°æŸä¸ªäº‹ä»¶å‘ç”Ÿã€‚æ …æ ä¸é—­é”çš„å…³é”®åŒºåˆ«åœ¨äºï¼Œæ‰€æœ‰çº¿ç¨‹å¿…é¡»åŒæ—¶åˆ°è¾¾æ …æ ä½ç½®æ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚é—­é”ç­‰å¾…äº‹ä»¶ï¼Œè€Œæ …æ ç­‰å¾…çº¿ç¨‹ã€‚
- CyclicBarrierå¯ä»¥ä½¿ä¸€å®šæ•°é‡çš„å‚ä¸æ–¹åå¤åœ¨æ …æ ä½ç½®æ±‡é›†ï¼Œå¸¸ç”¨åœ¨å¹¶è¡Œè¿­ä»£ç®—æ³•ã€‚
- Exchangeræ˜¯ä¸€ç§ä¸¤æ–¹æ …æ ï¼Œå„æ–¹åœ¨æ …æ äº¤æ¢æ•°æ®ã€‚å¦‚ä¸€ä¸ªçº¿ç¨‹è¯»æ•°æ®ï¼Œå¦ä¸€ä¸ªå†™æ•°æ®ã€‚

### 5.5 é«˜æ•ˆçš„ç¼“å­˜æœºåˆ¶
```java
public class Memoizer<A, V> implements Computable<A, V> {
    // ä½¿ç”¨å¹¶å‘å®¹å™¨ä¿è¯å®‰å…¨
    // ä½¿ç”¨Futureï¼Œé¿å…åœ¨Açº¿ç¨‹æ‰§è¡Œæ—¶ï¼ŒBçº¿ç¨‹æäº¤ç›¸åŒçš„ä»»åŠ¡ï¼Œé‡å¤è®¡ç®—ã€‚
    private final ConcurrentHashMap<A, Future<V>> cache = new ConcurrentHashMap<A, Future<V>>();
    private final Computable<A, V> c;

    public Memoizer(Computable<A, V> c) {
        this.c = c;
    }

    public V compute(final A arg) throws InterruptedException {
        while (true) {
            Future<V> f = cache.get(arg);
            if (f == null) {
                Callable<V> eval = new Callable<V>() {
                    public V call() throws InterruptedExcetion {
                        return c.comput(arg);
                    }
                };
                FutureTask<V> ft = new FutureTask<V>(eval);
                f = cache.putIfAbsent(arg, ft); //é¿å…åœ¨ç‰¹å®šæ—¶åºä¸‹ï¼Œé‡å¤è®¡ç®—ã€‚å¦‚Aã€BåŒæ—¶æ²¡æœ‰è·å–åˆ°ç¼“å­˜ï¼ŒåŒæ—¶put
                if (f == null) {
                    f = ft;
                    ft.run();
                }
            }
            try {
                return f.get();
            } catch (CancellationException e) {
                cache.remove(arg, f);
            } catch (ExecutionException e) {
                throw launderThrowable(e.getCause());
            }
        }
    }
}
```

## å°ç»“
- å¯å˜çŠ¶æ€æ˜¯è‡³å…³é‡è¦çš„ã€‚æ‰€æœ‰å¹¶å‘é—®é¢˜éƒ½å¯ä»¥å½’ç»“äºå¦‚ä½•åè°ƒå¯¹å¹¶å‘çŠ¶æ€çš„è®¿é—®ã€‚å¯å˜çŠ¶æ€è¶Šå°‘ï¼Œè¶Šå®¹æ˜“ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚
- å°½é‡å°†åŸŸå£°æ˜ä¸ºfinalï¼Œé™¤éä»–ä»¬æ˜¯å¯å˜çš„ã€‚
- ä¸å¯å˜å¯¹è±¡ä¸€å®šçº¿ç¨‹å®‰å…¨ã€‚
- å°è£…æœ‰åŠ©äºç®¡ç†å¤æ‚æ€§ã€‚æ˜“äºç»´æŠ¤ä¸å˜æ€§æ¡ä»¶
- ç”¨é”æ¥ä¿æŠ¤æ¯ä¸ªå¯å˜å˜é‡ã€‚
- å½“ä¿æŠ¤åŒä¸€ä¸ªä¸å˜æ€§æ¡ä»¶ä¸­çš„å˜é‡æ—¶ï¼Œç”¨åŒä¸€æŠŠé”ã€‚
- åœ¨æ‰§è¡Œå¤åˆæ“ä½œæ—¶ï¼Œè¦æŒæœ‰é”ã€‚
- å¦‚æœå¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå¯å˜å˜é‡æ—¶ï¼Œæ²¡æœ‰åŒæ­¥æœºåˆ¶ï¼Œé‚£ä¹ˆç¨‹åºä¼šå‡ºç°é—®é¢˜ã€‚
- ä¸è¦å‡è®¾ä¸éœ€è¦ä½¿ç”¨åŒæ­¥ã€‚
- åœ¨è®¾è®¡è¿‡ç¨‹ä¸­è€ƒè™‘çº¿ç¨‹å®‰å…¨ï¼Œæˆ–æŒ‡æ˜ä»–ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚
- å°†åŒæ­¥ç­–ç•¥æ–‡æ¡£åŒ–ã€‚ 